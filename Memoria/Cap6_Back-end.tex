% ---------------------------------------------------
%
% Trabajo de Fin de Grado. 
% Author: Alejandro Hernández Padrón. 
% Capítulo: Conclusiones y líneas de trabajo futuras. 
% Fichero: Cap5_ConclusionsAndFutureLinesOfWork.tex
%
% ----------------------------------------------------
%  
\chapter{Back-end de la aplicación} \label{chap:BackEnd} 

Si se recuerda, en el capítulo \ref{chap:Tecnologias} se habló sobre las tecnologías de Node.js y MongoDB, como servidor y base de datos respectivamente. Para poder implementar estas tecnologías se decidió por utilizar servicios en la nube para gestionarlos, facilitar su despliegue y con motivos de profundizar y adquirir conocimiento sobre este tipo de plataformas. Estos servicios son Heroku como servidor de la aplicación y mLab como base de datos. Ambos ofrecen una forma sencilla, accesible y escalable, para poder ejecutar la aplicación y estudiar las posibilidades y beneficios que ofrecen este tipo de servicios en la nube en la actualidad.

\section{Base de datos}

Todos los datos necesarios para el funcionamiento de la aplicación estarán alojados en una base de datos en la nube. mLab será el proveedor de servicio escogido para alojar la base de datos. Este proveedor ofrece bases de datos NoSQL que utilizan la tecnología MongoDB.

Crear la base de datos es muy sencillo con mLab. Simplemente hay que registrarse y crear una base de datos. Lo primero que se necesita es elegir un plan de datos. Como en la base de datos que se necesita no es necesario mucho espacio de almacenamiento, se optó por el plan gratuito que dispone de 500 megas. Posteriormente se fija el nombre de la base de datos que será ``bd-ull-AR".

\section{Configuración del servidor}

Se necesita configurar el servidor de Node.js para poder desplegarlo en Heroku y que funcione correctamente. A continuación, se explicarán los pasos seguidos para la implementación del servidor explicando su funcionamiento y su conexión con la base de datos.

\subsection{Requisitos previos}
Para toda la instalación e implementación del servidor Node.js se ha utilizado Linux como sistema operativo.

Previo a la implementación se necesitará crearse una cuenta en la plataforma de Heroku y en la de mLab. A su vez, se debe tener instalado GitHub, Node.js y Heroku. Para poder ejecutar los comandos que permitan creación y despliegue del servidor en la nube.

Dentro de la cuenta de Heroku, se crea un repositorio con el nombre de "server-ull-AR" que será el servidor de la aplicación en la nube.

\subsection{Implementación}

Terminados de instalar todos los requisitos necesarios, ya se puede empezar a implementar el servidor de Node.js.

Con el siguiente comando, ya se tiene preparado el repositorio para empezar a trabajar:

\begin{lstlisting}
    $ git clone https://github.com/heroku/server-ull-AR.git
\end{lstlisting}

Para empezar a trabajar con Node.js se necesita ejecutar el siguiente comando dentro del repositorio:

\begin{lstlisting}
    $ npm init 
\end{lstlisting}

Este comando resulta en la creación de un archivo llamado \texttt{package.json}. Este fichero se utiliza para administrar los paquetes disponibles en el ``Node Package Manager'' que se instalan localmente en el repositorio.

A continuación, se instalarán los paquetes necesarios para funcionamiento del servidor Node.js. Estos son:

\begin{itemize}
    \item \textbf{ExpressJS}: Express es una infraestructura de aplicaciones web Node.js mínima y flexible que proporciona un conjunto sólido de características para las aplicaciones web y móviles.
    \item \textbf{mongoose}: Mongoose es una librería para trabajar MongoDB y Node.js.
    \item \textbf{bodyparser}: Se necesitará para manejar las peticiones de JSON.
    \item \textbf{node-restful}: Sirve para manejar las peticiones recibidas del servidor y conectarse con una base de datos de MongoDB.
\end{itemize}

Con un comando se instalarán todos los paquetes y se guardan las dependencias utilizadas en el fichero \texttt{package.json}:

\begin{lstlisting}
    $ npm install --save express body-parser mongoose node-restful
\end{lstlisting}

El resultado del \texttt{package.json} sería el siguiente:

\lstset{numbers=left,  string=[s]{"}{"}, comment=[l]{:}, commentstyle=\color{black},}
\lstinputlisting[stringstyle=\color{blue}, caption={Contenido del fichero \texttt{package.json}.}, label={package.json}, ]{listings/package.json} %% LISTING

\subsubsection{Inicialización el servidor}

Una vez ya instalados todos los paquetes se crea el fichero \texttt{server.js}. Este fichero será el que inicie el servidor y contenga las variables que configuran el mismo (véase Listado \ref{lst:server.js}). 

\lstset{keywords={typeof, new, true, false, catch, function, return, null, catch, switch, var, if, in, while, do, else, case, break},
keywordstyle=\color{blue}\bfseries,
ndkeywords={class, export, boolean, throw, implements, import, this},
ndkeywordstyle=\color{darkgray}\bfseries,
identifierstyle=\color{black},
sensitive=false,
comment=[l]{//},
morecomment=[s]{/*}{*/},
commentstyle=\color{colString}\ttfamily,
stringstyle=\color{purple}\ttfamily,
morestring=[b]',
morestring=[b]"}

\begin{lstlisting}[ caption={Fichero \texttt{server.js}, configuración inicial del servidor.}, label={lst:server.js}]
    // Se declaran los paquetes que se necesitan
    var express = require('express');  
    var app = express();  // Se inicia la app
    // Se pone en modo escucha la app
    app.listen(3000, function(){
        console.log("Express server listening on port 3000"
      });

\end{lstlisting}

Para comprobar que todo funciona, se utilizará el siguiente comando, que correrá el servidor en local en el puerto 3000.
\begin{lstlisting}
    $ node server.js
\end{lstlisting}

Más adelante se terminará de configurar este fichero. A continuación se explicará la estructura y organización del servidor.

\subsubsection{Estructura de la aplicación}

Dentro de la carpeta principal del repositorio se han de crear dos subdirectorios:

\begin{itemize}
    \item \textbf{models/}
    \item \textbf{routes/}
\end{itemize}

A continuación se creará el fichero \texttt{ullSites.js} dentro de la carpeta de \textit{models/}. Este fichero contiene el modelo que conecta con la colección de la base de datos y maneja las respuestas como se verán más adelante.   

\lstinputlisting[language=JavaScript, caption={Fichero \texttt{ullSites.js}.}, label={code:ullSites.js},]{listings/ullSites.js} %% LISTING

Se necesitará una ruta por la cual el servidor responderá con la información que se solicite de la base de datos. Para ello en la carpeta \textit{routes/} se creará el fichero \texttt{api.js} (véase Listado \ref{lst:api.js}). Este fichero manejará las peticiones que lleguen al servidor a través de la ruta ``\textit{https://server\_url/api/}'' y se encargará principalmente de conectarse con la base de datos para responder a estas peticiones.

\lstinputlisting[language=JavaScript,caption={Fichero \texttt{api.js}.}, label={lst:api.js},]{listings/api.js} %% LISTING
 
En el caso de que se acceda a la ruta ``\textit{/api/ull-sites}'' del servidor con una petición ``HTTP'' de tipo ``GET'', se enviará una respuesta al cliente con toda la información de las instalaciones que se encuentran en la base de datos.

\subsubsection{Conexión con mLab}

Con la cuenta de mLab y base datos ya creada en mLab, solo se va a necesitar una url para poder acceder a ella y poder consultar, añadir y borrar datos. Esta url está disponible en la página principal de la base de datos en mLab y tiene el siguiente formato:

\begin{lstlisting}
    mongodb://<dbuser>:<dbpassword>@ds235181.mlab.com:35181/ull-AR
\end{lstlisting}

Donde ``dbuser'' es el usuario que se usó para crear la base de datos y ``dbpassword'' la contraseña. Para evitar que el usuario y contraseña queden expuestos públicamente en el repositorio, se utiliza una variable de entorno. En este caso hay que configurar la variable de entorno para que funcione en Heroku. Para hacerlo se necesita utilizar este comando en la terminal:

\begin{lstlisting}
    $heroku config:set PROD_MONGODB=mongodb://username:password@ds235181.mlab.com:35181/ull-AR
\end{lstlisting}

Posteriormente la variable ``PROD\_MONGODB" se utilizará para conectarse al base de datos una vez este desplegada en Heroku.

Solo se va a necesitar crear una colección para el proyecto. Para ello se accede a la base de datos en el navegador y se pincha en el botón de ``Add collection'' y se nombrará ``\textit{ull\_sites}''. Aquí se tiene la información de las instalaciones de la ULL. Los cuales se añadirán manualmente desde la página de mLab (véase Figura \ref{fig:ull-site}).


\subsubsection{Configuración final del servidor}

Por último, se tiene que terminar de configurar el fichero \texttt{server.js} que contiene el servidor. Se necesitará indicar al servidor la url de la base de datos de mLab y de disponer que las rutas de la aplicación estén bien configuradas para responder a las solicitudes. 

\lstinputlisting[language=JavaScript,caption={Configuración final del fichero \texttt{server.js}. }, label={code:server.js},]{listings/server.js} %% LISTING

\subsection{Despliegue en Heroku}

Con el servidor ya configurado, se puede realizar el despliegue en Heroku. Para ello se necesitará crear un fichero \texttt{Procfile} en la raíz del repositorio, que le dirá a Heroku cuál es el fichero que inicia el servidor.

\begin{lstlisting}
    web: node server.js
\end{lstlisting}

Para desplegarlo en Heroku se necesitarán tres comandos:

\begin{lstlisting}
    $ git add .
    $ git commit -m "Despliegue del servidor"
    $ git push heroku master
\end{lstlisting}

Con estos pasos completados ya se tiene el servidor desplegado y funcionando en la url: \href{https://server-ull-AR.herokuapp.com}{https://server-ull-AR.herokuapp.com}.




